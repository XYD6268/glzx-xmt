<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改密码</title>
    <style>
        body {
            background: #181818;
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: 32px auto;
            padding: 16px;
            background: #222;
            border-radius: 12px;
            box-shadow: 0 2px 8px #0006;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #444;
            flex-wrap: wrap;
            gap: 16px;
        }
        .title {
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin: 0;
        }
        .nav-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 8px 16px;
            background: #444;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .nav-btn:hover {
            background: #666;
            color: #fff;
        }
        .form-container {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #333;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .flash-messages {
            margin-bottom: 20px;
        }
        .flash-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .flash-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .security-tips {
            background: #333;
            border-left: 4px solid #ffc107;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 6px;
        }
        .security-tips h4 {
            color: #ffc107;
            margin-top: 0;
            margin-bottom: 12px;
        }
        .security-tips ul {
            margin-bottom: 0;
            color: #ccc;
        }
        .security-tips li {
            margin-bottom: 8px;
        }
        .password-strength {
            margin-top: 8px;
            font-size: 12px;
        }
        .strength-weak {
            color: #dc3545;
        }
        .strength-medium {
            color: #ffc107;
        }
        .strength-strong {
            color: #28a745;
        }
        @media (max-width: 768px) {
            .container {
                margin: 16px auto;
                padding: 12px;
                max-width: 95%;
            }
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .nav-links {
                justify-content: center;
            }
            .btn-group {
                flex-direction: column;
                gap: 8px;
            }
            .btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- 隐藏的用户数据元素，用于JavaScript检查用户权限 -->
    <div id="userData" 
         data-user-logged-in="{{ 'true' if session.get('user_id') else 'false' }}" 
         data-user-role="{{ session.get('role', 0) }}" 
         style="display: none;"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">🔒 修改密码</h1>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-btn">🏠 首页</a>
                <a href="{{ url_for('my_photos') }}" class="nav-btn">📷 我的照片</a>
                <a href="{{ url_for('logout') }}" class="nav-btn">🚪 退出登录</a>
            </div>
        </div>

        <!-- 安全提示 -->
        <div class="security-tips">
            <h4>🛡️ 密码安全提示</h4>
            <ul>
                <li>密码长度至少6位，建议8位以上</li>
                <li>建议包含字母、数字和特殊字符</li>
                <li>不要使用过于简单的密码（如123456、password等）</li>
                <li>定期更换密码，不要与其他网站使用相同密码</li>
            </ul>
        </div>

        <!-- Flash消息 -->
        <div class="flash-messages">
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="flash-message flash-error">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="form-container">
            <form method="POST" id="changePasswordForm">
                <div class="form-group">
                    <label for="current_password">当前密码</label>
                    <input type="password" id="current_password" name="current_password" 
                           placeholder="请输入当前密码" required>
                    <div class="help-text">请输入您当前使用的密码</div>
                </div>

                <div class="form-group">
                    <label for="new_password">新密码</label>
                    <input type="password" id="new_password" name="new_password" 
                           placeholder="请输入新密码" required minlength="6">
                    <div class="help-text">密码长度至少6位</div>
                    <div id="password_strength" class="password-strength"></div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">确认新密码</label>
                    <input type="password" id="confirm_password" name="confirm_password" 
                           placeholder="请再次输入新密码" required minlength="6">
                    <div class="help-text">请再次输入新密码以确认</div>
                    <div id="password_match" class="password-strength"></div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">🔑 修改密码</button>
                    <a href="{{ url_for('my_photos') }}" class="btn btn-secondary">❌ 取消</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 密码强度检测
        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = [];
            
            if (password.length >= 8) {
                strength += 1;
            } else if (password.length >= 6) {
                strength += 0.5;
                feedback.push('建议8位以上');
            } else {
                feedback.push('密码太短');
            }
            
            if (/[a-z]/.test(password)) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            
            let level, className;
            if (strength < 2) {
                level = '弱';
                className = 'strength-weak';
                feedback.push('建议包含字母和数字');
            } else if (strength < 4) {
                level = '中等';
                className = 'strength-medium';
                feedback.push('建议加入特殊字符');
            } else {
                level = '强';
                className = 'strength-strong';
            }
            
            return { level, className, feedback };
        }

        // 检查密码匹配
        function checkPasswordMatch() {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const matchElement = document.getElementById('password_match');
            
            if (confirmPassword === '') {
                matchElement.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchElement.textContent = '✓ 密码匹配';
                matchElement.className = 'password-strength strength-strong';
            } else {
                matchElement.textContent = '✗ 密码不匹配';
                matchElement.className = 'password-strength strength-weak';
            }
        }

        // 实时密码强度检测
        document.getElementById('new_password').addEventListener('input', function() {
            const password = this.value;
            const strengthElement = document.getElementById('password_strength');
            
            if (password === '') {
                strengthElement.textContent = '';
                return;
            }
            
            const result = checkPasswordStrength(password);
            strengthElement.textContent = `密码强度: ${result.level}${result.feedback.length ? ' - ' + result.feedback.join(', ') : ''}`;
            strengthElement.className = `password-strength ${result.className}`;
            
            // 检查密码匹配
            checkPasswordMatch();
        });

        // 实时密码匹配检测
        document.getElementById('confirm_password').addEventListener('input', checkPasswordMatch);

        // 表单提交验证
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (currentPassword === '') {
                alert('请输入当前密码');
                e.preventDefault();
                return;
            }
            
            if (newPassword.length < 6) {
                alert('新密码长度至少6位');
                e.preventDefault();
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('两次输入的新密码不一致');
                e.preventDefault();
                return;
            }
            
            if (currentPassword === newPassword) {
                alert('新密码不能与当前密码相同');
                e.preventDefault();
                return;
            }
        });

        // 防护功能 - 检查当前用户是否需要限制
        const userData = document.getElementById('userData');
        const userLoggedIn = userData.getAttribute('data-user-logged-in') === 'true';
        const userRole = parseInt(userData.getAttribute('data-user-role')) || 0;
        
        // 检查当前用户是否需要限制（未登录用户或普通用户，管理员除外）
        const shouldRestrict = !userLoggedIn || userRole < 2;
        
        if (shouldRestrict) {
            // 禁用右键菜单
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // 禁用开发者工具快捷键
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
                    (e.ctrlKey && e.key === 'u')) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // 禁用文本选择
            document.addEventListener('selectstart', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    e.preventDefault();
                    return false;
                }
            });
        }
    </script>
</body>
</html>
