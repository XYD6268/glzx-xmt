<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ”¹å¯†ç </title>
    <style>
        body {
            background: #181818;
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: 32px auto;
            padding: 16px;
            background: #222;
            border-radius: 12px;
            box-shadow: 0 2px 8px #0006;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #444;
            flex-wrap: wrap;
            gap: 16px;
        }
        .title {
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin: 0;
        }
        .nav-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .nav-btn {
            padding: 8px 16px;
            background: #444;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .nav-btn:hover {
            background: #666;
            color: #fff;
        }
        .form-container {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #333;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .flash-messages {
            margin-bottom: 20px;
        }
        .flash-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .flash-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .security-tips {
            background: #333;
            border-left: 4px solid #ffc107;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 6px;
        }
        .security-tips h4 {
            color: #ffc107;
            margin-top: 0;
            margin-bottom: 12px;
        }
        .security-tips ul {
            margin-bottom: 0;
            color: #ccc;
        }
        .security-tips li {
            margin-bottom: 8px;
        }
        .password-strength {
            margin-top: 8px;
            font-size: 12px;
        }
        .strength-weak {
            color: #dc3545;
        }
        .strength-medium {
            color: #ffc107;
        }
        .strength-strong {
            color: #28a745;
        }
        @media (max-width: 768px) {
            .container {
                margin: 16px auto;
                padding: 12px;
                max-width: 95%;
            }
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .nav-links {
                justify-content: center;
            }
            .btn-group {
                flex-direction: column;
                gap: 8px;
            }
            .btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- éšè—çš„ç”¨æˆ·æ•°æ®å…ƒç´ ï¼Œç”¨äºJavaScriptæ£€æŸ¥ç”¨æˆ·æƒé™ -->
    <div id="userData" 
         data-user-logged-in="{{ 'true' if session.get('user_id') else 'false' }}" 
         data-user-role="{{ session.get('role', 0) }}" 
         style="display: none;"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ”’ ä¿®æ”¹å¯†ç </h1>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-btn">ğŸ  é¦–é¡µ</a>
                <a href="{{ url_for('my_photos') }}" class="nav-btn">ğŸ“· æˆ‘çš„ç…§ç‰‡</a>
                <a href="{{ url_for('logout') }}" class="nav-btn">ğŸšª é€€å‡ºç™»å½•</a>
            </div>
        </div>

        <!-- å®‰å…¨æç¤º -->
        <div class="security-tips">
            <h4>ğŸ›¡ï¸ å¯†ç å®‰å…¨æç¤º</h4>
            <ul>
                <li>å¯†ç é•¿åº¦è‡³å°‘6ä½ï¼Œå»ºè®®8ä½ä»¥ä¸Š</li>
                <li>å»ºè®®åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦</li>
                <li>ä¸è¦ä½¿ç”¨è¿‡äºç®€å•çš„å¯†ç ï¼ˆå¦‚123456ã€passwordç­‰ï¼‰</li>
                <li>å®šæœŸæ›´æ¢å¯†ç ï¼Œä¸è¦ä¸å…¶ä»–ç½‘ç«™ä½¿ç”¨ç›¸åŒå¯†ç </li>
            </ul>
        </div>

        <!-- Flashæ¶ˆæ¯ -->
        <div class="flash-messages">
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="flash-message flash-error">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="form-container">
            <form method="POST" id="changePasswordForm">
                <div class="form-group">
                    <label for="current_password">å½“å‰å¯†ç </label>
                    <input type="password" id="current_password" name="current_password" 
                           placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
                    <div class="help-text">è¯·è¾“å…¥æ‚¨å½“å‰ä½¿ç”¨çš„å¯†ç </div>
                </div>

                <div class="form-group">
                    <label for="new_password">æ–°å¯†ç </label>
                    <input type="password" id="new_password" name="new_password" 
                           placeholder="è¯·è¾“å…¥æ–°å¯†ç " required minlength="6">
                    <div class="help-text">å¯†ç é•¿åº¦è‡³å°‘6ä½</div>
                    <div id="password_strength" class="password-strength"></div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirm_password" name="confirm_password" 
                           placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required minlength="6">
                    <div class="help-text">è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ä»¥ç¡®è®¤</div>
                    <div id="password_match" class="password-strength"></div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
                    <a href="{{ url_for('my_photos') }}" class="btn btn-secondary">âŒ å–æ¶ˆ</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å¯†ç å¼ºåº¦æ£€æµ‹
        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = [];
            
            if (password.length >= 8) {
                strength += 1;
            } else if (password.length >= 6) {
                strength += 0.5;
                feedback.push('å»ºè®®8ä½ä»¥ä¸Š');
            } else {
                feedback.push('å¯†ç å¤ªçŸ­');
            }
            
            if (/[a-z]/.test(password)) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            
            let level, className;
            if (strength < 2) {
                level = 'å¼±';
                className = 'strength-weak';
                feedback.push('å»ºè®®åŒ…å«å­—æ¯å’Œæ•°å­—');
            } else if (strength < 4) {
                level = 'ä¸­ç­‰';
                className = 'strength-medium';
                feedback.push('å»ºè®®åŠ å…¥ç‰¹æ®Šå­—ç¬¦');
            } else {
                level = 'å¼º';
                className = 'strength-strong';
            }
            
            return { level, className, feedback };
        }

        // æ£€æŸ¥å¯†ç åŒ¹é…
        function checkPasswordMatch() {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const matchElement = document.getElementById('password_match');
            
            if (confirmPassword === '') {
                matchElement.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchElement.textContent = 'âœ“ å¯†ç åŒ¹é…';
                matchElement.className = 'password-strength strength-strong';
            } else {
                matchElement.textContent = 'âœ— å¯†ç ä¸åŒ¹é…';
                matchElement.className = 'password-strength strength-weak';
            }
        }

        // å®æ—¶å¯†ç å¼ºåº¦æ£€æµ‹
        document.getElementById('new_password').addEventListener('input', function() {
            const password = this.value;
            const strengthElement = document.getElementById('password_strength');
            
            if (password === '') {
                strengthElement.textContent = '';
                return;
            }
            
            const result = checkPasswordStrength(password);
            strengthElement.textContent = `å¯†ç å¼ºåº¦: ${result.level}${result.feedback.length ? ' - ' + result.feedback.join(', ') : ''}`;
            strengthElement.className = `password-strength ${result.className}`;
            
            // æ£€æŸ¥å¯†ç åŒ¹é…
            checkPasswordMatch();
        });

        // å®æ—¶å¯†ç åŒ¹é…æ£€æµ‹
        document.getElementById('confirm_password').addEventListener('input', checkPasswordMatch);

        // è¡¨å•æäº¤éªŒè¯
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (currentPassword === '') {
                alert('è¯·è¾“å…¥å½“å‰å¯†ç ');
                e.preventDefault();
                return;
            }
            
            if (newPassword.length < 6) {
                alert('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½');
                e.preventDefault();
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                e.preventDefault();
                return;
            }
            
            if (currentPassword === newPassword) {
                alert('æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ');
                e.preventDefault();
                return;
            }
        });

        // é˜²æŠ¤åŠŸèƒ½ - æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦éœ€è¦é™åˆ¶
        const userData = document.getElementById('userData');
        const userLoggedIn = userData.getAttribute('data-user-logged-in') === 'true';
        const userRole = parseInt(userData.getAttribute('data-user-role')) || 0;
        
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦éœ€è¦é™åˆ¶ï¼ˆæœªç™»å½•ç”¨æˆ·æˆ–æ™®é€šç”¨æˆ·ï¼Œç®¡ç†å‘˜é™¤å¤–ï¼‰
        const shouldRestrict = !userLoggedIn || userRole < 2;
        
        if (shouldRestrict) {
            // ç¦ç”¨å³é”®èœå•
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // ç¦ç”¨å¼€å‘è€…å·¥å…·å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
                    (e.ctrlKey && e.key === 'u')) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // ç¦ç”¨æ–‡æœ¬é€‰æ‹©
            document.addEventListener('selectstart', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    e.preventDefault();
                    return false;
                }
            });
        }
    </script>
</body>
</html>
